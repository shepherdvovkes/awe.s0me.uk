<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UNIX/32V Terminal ~ %</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400&display=swap');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            background: #000;
            font-family: 'IBM Plex Mono', 'Courier New', monospace;
            font-size: 16px;
            overflow: hidden;
            position: relative;
        }
        
        /* Three.js Canvas for CRT effects */
        #crt-canvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1000;
            pointer-events: none;
        }
        
        /* Startup Animation */
        .startup-animation {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100vh;
            background: #000;
            z-index: 3000;
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: 'IBM Plex Mono', 'Courier New', monospace;
        }
        
        .startup-text {
            color: #33ff33;
            font-size: 24px;
            text-shadow: 
                0 0 2px #33ff33,
                0 0 4px #33ff33,
                0 0 6px rgba(51, 255, 51, 0.5);
            opacity: 0;
            transform: translateY(20px);
            animation: textGlow 2s ease-in-out infinite alternate;
        }
        
        @keyframes textGlow {
            0% {
                text-shadow: 
                    0 0 2px #33ff33,
                    0 0 4px #33ff33,
                    0 0 6px rgba(51, 255, 51, 0.5);
            }
            100% {
                text-shadow: 
                    0 0 4px #33ff33,
                    0 0 8px #33ff33,
                    0 0 12px rgba(51, 255, 51, 0.8),
                    0 0 16px rgba(51, 255, 51, 0.6);
            }
        }
        
        .startup-text.visible {
            opacity: 1;
            transform: translateY(0);
            transition: opacity 0.3s ease, transform 0.3s ease;
        }
        
        .tunnel-animation {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100vh;
            background: #000;
            z-index: 2500;
            display: none;
            perspective: 1000px;
        }
        
        .tunnel-container {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 100%;
            height: 100%;
            transform-style: preserve-3d;
        }
        
        .tunnel-ring {
            position: absolute;
            top: 50%;
            left: 50%;
            border: 2px solid #33ff33;
            border-radius: 50%;
            transform: translate(-50%, -50%);
            animation: tunnelMove 5s linear infinite;
            box-shadow: 
                0 0 10px #33ff33,
                0 0 20px rgba(51, 255, 51, 0.5),
                inset 0 0 10px rgba(51, 255, 51, 0.3);
        }
        
        @keyframes tunnelMove {
            0% {
                width: 10px;
                height: 10px;
                opacity: 1;
                transform: translate(-50%, -50%) translateZ(0px) scale(1);
            }
            50% {
                width: 500px;
                height: 500px;
                opacity: 0.8;
                transform: translate(-50%, -50%) translateZ(250px) scale(1.2);
            }
            100% {
                width: 1200px;
                height: 1200px;
                opacity: 0;
                transform: translate(-50%, -50%) translateZ(600px) scale(2);
            }
        }
        
        .tunnel-ring:nth-child(1) { animation-delay: 0s; }
        .tunnel-ring:nth-child(2) { animation-delay: 0.05s; }
        .tunnel-ring:nth-child(3) { animation-delay: 0.1s; }
        .tunnel-ring:nth-child(4) { animation-delay: 0.15s; }
        .tunnel-ring:nth-child(5) { animation-delay: 0.2s; }
        .tunnel-ring:nth-child(6) { animation-delay: 0.25s; }
        .tunnel-ring:nth-child(7) { animation-delay: 0.3s; }
        .tunnel-ring:nth-child(8) { animation-delay: 0.35s; }
        .tunnel-ring:nth-child(9) { animation-delay: 0.4s; }
        .tunnel-ring:nth-child(10) { animation-delay: 0.45s; }
        .tunnel-ring:nth-child(11) { animation-delay: 0.5s; }
        .tunnel-ring:nth-child(12) { animation-delay: 0.55s; }
        .tunnel-ring:nth-child(13) { animation-delay: 0.6s; }
        .tunnel-ring:nth-child(14) { animation-delay: 0.65s; }
        .tunnel-ring:nth-child(15) { animation-delay: 0.7s; }
        .tunnel-ring:nth-child(16) { animation-delay: 0.75s; }
        .tunnel-ring:nth-child(17) { animation-delay: 0.8s; }
        .tunnel-ring:nth-child(18) { animation-delay: 0.85s; }
        .tunnel-ring:nth-child(19) { animation-delay: 0.9s; }
        .tunnel-ring:nth-child(20) { animation-delay: 0.95s; }
        .tunnel-ring:nth-child(21) { animation-delay: 1s; }
        .tunnel-ring:nth-child(22) { animation-delay: 1.05s; }
        .tunnel-ring:nth-child(23) { animation-delay: 1.1s; }
        .tunnel-ring:nth-child(24) { animation-delay: 1.15s; }
        .tunnel-ring:nth-child(25) { animation-delay: 1.2s; }
        .tunnel-ring:nth-child(26) { animation-delay: 1.25s; }
        .tunnel-ring:nth-child(27) { animation-delay: 1.3s; }
        .tunnel-ring:nth-child(28) { animation-delay: 1.35s; }
        .tunnel-ring:nth-child(29) { animation-delay: 1.4s; }
        .tunnel-ring:nth-child(30) { animation-delay: 1.45s; }
        
        /* Login screen entrance effect */
        .login-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100vh;
            background: #000;
            z-index: 2000;
            transform: scale(0.1);
            opacity: 0;
            transition: transform 1s ease-out, opacity 1s ease-out;
        }
        
        .login-screen.entering {
            transform: scale(1);
            opacity: 1;
        }
        .login-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100vh;
            background: #000;
            z-index: 2000;
        }
        
        .login-screen .terminal {
            width: 100%;
            height: 100%;
            color: #33ff33;
            font-size: 13px;
            line-height: 1.3;
            position: relative;
            z-index: 10;
            text-shadow: 
                0 0 2px #33ff33,
                0 0 4px #33ff33,
                0 0 6px rgba(51, 255, 51, 0.5);
            pointer-events: auto;
            padding: 20px;
        }
        
        .login-output {
            height: calc(100% - 100px);
            overflow-y: auto;
            margin-bottom: 20px;
            scrollbar-width: none;
            -ms-overflow-style: none;
            scroll-behavior: smooth;
        }
        
        .login-output::-webkit-scrollbar {
            display: none;
        }
        
        .login-prompt-line, .password-prompt-line {
            display: flex;
            align-items: center;
            position: relative;
            margin: 10px 0;
        }
        
        .login-prompt {
            color: #33ff33;
            margin-right: 5px;
            text-shadow: 
                0 0 2px #33ff33,
                0 0 4px #33ff33;
        }
        
        .login-input {
            background: transparent;
            border: none;
            color: #33ff33;
            font-family: inherit;
            font-size: inherit;
            outline: none;
            flex: 1;
            caret-color: #33ff33;
            text-shadow: 
                0 0 2px #33ff33,
                0 0 4px #33ff33;
        }
        
        /* Terminal container - full screen */
        .terminal-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: #000;
            display: flex;
            justify-content: center;
            align-items: center;
            perspective: 1000px;
        }
        
        /* CRT Monitor Frame - full screen */
        .crt-monitor {
            width: 100%;
            height: 100%;
            background: 
                radial-gradient(circle at center, #1a1a1a 0%, #000 70%),
                linear-gradient(135deg, #333 0%, #111 50%, #000 100%);
            border-radius: 0;
            padding: 20px;
            box-shadow: 
                inset 0 0 50px rgba(0, 0, 0, 0.8),
                0 0 100px rgba(0, 0, 0, 0.9),
                0 20px 50px rgba(0, 0, 0, 0.7);
            position: relative;
            transform: none;
        }
        
        /* Curved CRT Screen - full screen */
        .crt-screen {
            width: 100%;
            height: 100%;
            background: 
                radial-gradient(ellipse 80% 60% at 50% 40%, #002200 0%, #001100 40%, #000800 70%, #000000 100%);
            border-radius: 10px;
            padding: 20px;
            position: relative;
            overflow: hidden;
            transform: none;
            box-shadow: 
                inset 0 0 100px rgba(0, 0, 0, 0.9),
                inset 0 0 50px rgba(0, 100, 0, 0.1);
        }
        
        /* Terminal content - unified font size */
        .terminal {
            width: 100%;
            height: 100%;
            color: #33ff33;
            font-size: 16px;
            line-height: 1.4;
            position: relative;
            z-index: 10;
            text-shadow: 
                0 0 2px #33ff33,
                0 0 4px #33ff33,
                0 0 6px rgba(51, 255, 51, 0.5);
            pointer-events: auto;
        }
        
        .system-info {
            font-size: 16px;
            line-height: 1.4;
            margin-bottom: 20px;
        }
        
        .system-info div {
            margin: 3px 0;
        }
        
        .terminal-output {
            height: calc(100% - 150px);
            overflow-y: auto;
            margin-bottom: 20px;
            scrollbar-width: none;
            -ms-overflow-style: none;
            scroll-behavior: smooth;
        }
        
        .terminal-output::-webkit-scrollbar {
            display: none;
        }
        
        .output-line {
            margin: 3px 0;
            word-wrap: break-word;
        }
        
        .prompt-line {
            display: flex;
            align-items: center;
            position: relative;
            z-index: 50;
        }
        
        .prompt {
            color: #33ff33;
            margin-right: 5px;
            font-size: 16px;
            text-shadow: 
                0 0 2px #33ff33,
                0 0 4px #33ff33;
        }
        
        .command-input {
            background: transparent;
            border: none;
            color: #33ff33;
            font-family: inherit;
            font-size: 16px;
            outline: none;
            flex: 1;
            caret-color: #33ff33;
            text-shadow: 
                0 0 2px #33ff33,
                0 0 4px #33ff33;
            position: relative;
            z-index: 100;
        }
        
        .cursor {
            display: inline-block;
            width: 8px;
            height: 16px;
            background: #33ff33;
            margin-left: 2px;
            animation: cursorBlink 1s infinite;
            box-shadow: 0 0 5px #33ff33;
            vertical-align: text-bottom;
        }
        
        @keyframes cursorBlink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0; }
        }
        
        .success { color: #44ff44; }
        .error { color: #ff4444; }
        .info { color: #4444ff; }
        .highlight { 
            color: #ffff44; 
            text-shadow: 0 0 3px #ffff44;
        }
        .motd { 
            color: #33ff33; 
            text-shadow: 0 0 2px #33ff33, 0 0 4px #33ff33;
            margin: 3px 0;
        }
        
        /* Matrix Follow the White Rabbit Effect */
        .matrix-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #000;
            z-index: 5000;
            display: none;
            font-family: 'Courier New', monospace;
            color: #00ff00;
            text-align: center;
            padding-top: 40vh;
        }
        
        .matrix-text {
            font-size: 24px;
            text-shadow: 0 0 10px #00ff00;
            margin-bottom: 20px;
        }
        

        
        /* CRT Power On/Off Effects */
        .crt-power-on {
            animation: crtPowerOn 2s ease-out forwards;
        }
        
        .crt-power-off {
            animation: crtPowerOff 1.5s ease-in forwards;
        }
        
        @keyframes crtPowerOn {
            0% {
                transform: scale(0.01);
                opacity: 0;
                filter: brightness(0) contrast(0);
            }
            20% {
                transform: scale(0.1);
                opacity: 0.1;
                filter: brightness(0.1) contrast(0.1);
            }
            50% {
                transform: scale(0.5);
                opacity: 0.5;
                filter: brightness(0.5) contrast(0.5);
            }
            80% {
                transform: scale(0.9);
                opacity: 0.8;
                filter: brightness(0.8) contrast(0.8);
            }
            100% {
                transform: scale(1);
                opacity: 1;
                filter: brightness(1) contrast(1);
            }
        }
        
        @keyframes crtPowerOff {
            0% {
                transform: scale(1);
                opacity: 1;
                filter: brightness(1) contrast(1);
            }
            20% {
                transform: scale(0.9);
                opacity: 0.8;
                filter: brightness(0.8) contrast(0.8);
            }
            50% {
                transform: scale(0.5);
                opacity: 0.5;
                filter: brightness(0.5) contrast(0.5);
            }
            80% {
                transform: scale(0.1);
                opacity: 0.1;
                filter: brightness(0.1) contrast(0.1);
            }
            100% {
                transform: scale(0.01);
                opacity: 0;
                filter: brightness(0) contrast(0);
            }
        }
        
        /* Visual Menu - MUTT Style */
        .visual-menu {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 17, 0, 0.95);
            border: 2px solid #33ff33;
            border-radius: 5px;
            width: 600px;
            max-width: 90vw;
            z-index: 2000;
            -webkit-backdrop-filter: blur(10px);
            backdrop-filter: blur(10px);
            box-shadow: 
                0 0 50px rgba(51, 255, 51, 0.3),
                inset 0 0 20px rgba(0, 0, 0, 0.5);
        }
        
        .mutt-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 15px;
            border-bottom: 1px solid #33ff33;
            background: rgba(51, 255, 51, 0.1);
        }
        
        .mutt-title {
            color: #33ff33;
            font-weight: bold;
            text-shadow: 0 0 5px #33ff33;
        }
        
        .mutt-menu {
            padding: 10px 0;
        }
        
        .menu-item {
            display: flex;
            align-items: center;
            padding: 8px 15px;
            cursor: pointer;
            transition: background 0.2s ease;
            border-bottom: 1px solid rgba(51, 255, 51, 0.2);
        }
        
        .menu-item:hover {
            background: rgba(51, 255, 51, 0.1);
        }
        
        .menu-item.selected {
            background: rgba(51, 255, 51, 0.2);
        }
        
        .menu-cursor {
            color: #33ff33;
            margin-right: 10px;
            font-weight: bold;
            min-width: 10px;
            text-shadow: 0 0 3px #33ff33;
        }
        
        .menu-text {
            color: #33ff33;
            font-weight: bold;
            margin-right: 15px;
            min-width: 120px;
            text-shadow: 0 0 2px #33ff33;
        }
        
        .menu-desc {
            color: #33ff33;
            opacity: 0.8;
            font-size: 12px;
            text-shadow: 0 0 1px #33ff33;
        }
        
        .mutt-footer {
            padding: 10px 15px;
            border-top: 1px solid #33ff33;
            background: rgba(51, 255, 51, 0.05);
        }
        
        .mutt-help {
            color: #33ff33;
            font-size: 11px;
            text-align: center;
            opacity: 0.7;
            text-shadow: 0 0 2px #33ff33;
        }
        
        .close-btn {
            position: absolute;
            top: 10px;
            right: 15px;
            background: none;
            border: 1px solid #ff4444;
            color: #ff4444;
            cursor: pointer;
            padding: 5px 10px;
            font-family: inherit;
        }
        
        /* Matrix Screensaver */
        .matrix-screensaver {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #000;
            z-index: 3000;
            display: none;
        }
        
        #matrix-canvas {
            width: 100%;
            height: 100%;
            background: #000;
        }
        
        .screensaver-text {
            position: absolute;
            bottom: 50px;
            left: 50%;
            transform: translateX(-50%);
            color: #33ff33;
            font-family: 'IBM Plex Mono', monospace;
            font-size: 14px;
            text-align: center;
            text-shadow: 0 0 10px #33ff33;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 0.7; }
            50% { opacity: 1; }
        }
        
        /* Mobile responsive */
        @media (max-width: 768px) {
            .crt-monitor {
                width: 95%;
                height: 90vh;
                padding: 20px;
            }
            
            .terminal {
                font-size: 11px;
            }
            
            .menu-grid {
                grid-template-columns: 1fr;
            }
            
            .visual-menu {
                width: 90%;
                max-width: 300px;
            }
        }
        
        @media (min-width: 769px) {
            .menu-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    </style>
</head>
<body>
    <!-- Startup Animation -->
    <div class="startup-animation" id="startupAnimation">
        <div class="startup-text" id="startupText"></div>
    </div>
    
    <!-- Tunnel Animation -->
    <div class="tunnel-animation" id="tunnelAnimation">
        <div class="tunnel-container">
            <div class="tunnel-ring"></div>
            <div class="tunnel-ring"></div>
            <div class="tunnel-ring"></div>
            <div class="tunnel-ring"></div>
            <div class="tunnel-ring"></div>
            <div class="tunnel-ring"></div>
            <div class="tunnel-ring"></div>
            <div class="tunnel-ring"></div>
            <div class="tunnel-ring"></div>
            <div class="tunnel-ring"></div>
            <div class="tunnel-ring"></div>
            <div class="tunnel-ring"></div>
            <div class="tunnel-ring"></div>
            <div class="tunnel-ring"></div>
            <div class="tunnel-ring"></div>
            <div class="tunnel-ring"></div>
            <div class="tunnel-ring"></div>
            <div class="tunnel-ring"></div>
            <div class="tunnel-ring"></div>
            <div class="tunnel-ring"></div>
            <div class="tunnel-ring"></div>
            <div class="tunnel-ring"></div>
            <div class="tunnel-ring"></div>
            <div class="tunnel-ring"></div>
            <div class="tunnel-ring"></div>
            <div class="tunnel-ring"></div>
            <div class="tunnel-ring"></div>
            <div class="tunnel-ring"></div>
            <div class="tunnel-ring"></div>
        </div>
    </div>
    
    <!-- Login Screen -->
    <div class="login-screen" id="loginScreen">
        <div class="terminal">
            <div class="login-output" id="loginOutput">
                <!-- Boot messages will be added here -->
            </div>
            
            <div class="login-prompt-line">
                <span class="login-prompt">login: </span>
                <input type="text" class="login-input" id="loginInput" autofocus aria-label="Username" title="Enter username">
            </div>
            
            <div class="password-prompt-line" id="passwordPromptLine" style="display: none;">
                <span class="login-prompt">Password: </span>
                <input type="password" class="login-input" id="passwordInput" aria-label="Password" title="Enter password">
            </div>
        </div>
    </div>
    
    <!-- Terminal Screen (initially hidden) -->
    <div class="terminal-container" id="terminalContainer" style="display: none;">
        <div class="crt-monitor">
            <div class="crt-screen">
                <div class="terminal">
                    <div class="system-info">
                        <div>UNIX/32V - PDP-11/70 Compatible System</div>
                        <div>Teletype Corp. Model ASR-37 Terminal</div>
                        <div>Berkeley Software Distribution - Version 1.0</div>
                        <div>Memory: 128K words | Disk: RK05 Cartridge</div>
                        <div>Login TTY: /dev/tty03 at 300 baud</div>
                        <div>Login: Mon Aug  4 14:30:21 PDT 1975</div>
                        <div></div>
                    </div>
                    
                    <div class="terminal-output" id="output">
                        <!-- Boot messages will be dynamically added with typing effect -->
                    </div>
                    
                    <div class="prompt-line">
                        <span class="prompt" id="promptSymbol">%</span>
                        <input type="text" class="command-input" id="commandInput" autofocus placeholder="Type a command...">
                        <div class="cursor"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Matrix Screensaver -->
    <div class="matrix-screensaver" id="matrixScreensaver">
        <canvas id="matrix-canvas"></canvas>
        <div class="screensaver-text">
            <div>UNIX/32V Terminal - Press any key to continue</div>
            <div style="font-size: 12px; margin-top: 10px;">PDP-11/70 System Idle</div>
        </div>
    </div>
    
    <!-- Canvas for CRT effects -->
    <canvas id="crt-canvas"></canvas>
    
    <!-- Matrix Follow the White Rabbit Effect -->
    <div class="matrix-overlay" id="matrixOverlay">
        <div class="matrix-text" id="matrixText"></div>
    </div>
    
    <!-- Visual Menu -->
    <div class="visual-menu" id="visualMenu">
        <div class="mutt-header">
            <div class="mutt-title">MUTT Terminal Menu v1.0</div>
            <button class="close-btn" onclick="closeVisualMenu()">[X]</button>
        </div>
        
        <div class="mutt-menu">
            <div class="menu-item" data-command="about" onclick="executeMenuCommand('about')">
                <span class="menu-cursor" id="cursor-0">></span>
                <span class="menu-text">About System</span>
                <span class="menu-desc">System information and details</span>
            </div>
            
            <div class="menu-item" data-command="projects" onclick="executeMenuCommand('projects')">
                <span class="menu-cursor" id="cursor-1"> </span>
                <span class="menu-text">Projects</span>
                <span class="menu-desc">Portfolio and work examples</span>
            </div>
            
            <div class="menu-item" data-command="contact" onclick="executeMenuCommand('contact')">
                <span class="menu-cursor" id="cursor-2"> </span>
                <span class="menu-text">Contact</span>
                <span class="menu-desc">Get in touch information</span>
            </div>
            
            <div class="menu-item" data-command="help" onclick="executeMenuCommand('help')">
                <span class="menu-cursor" id="cursor-3"> </span>
                <span class="menu-text">Help</span>
                <span class="menu-desc">Command reference and usage</span>
            </div>
            
            <!-- Admin-only networking options -->
            <div class="menu-item admin-only" data-command="ping" onclick="executeMenuCommand('ping')" style="display: none;">
                <span class="menu-cursor" id="cursor-4"> </span>
                <span class="menu-text">Ping</span>
                <span class="menu-desc">Test network connectivity</span>
            </div>
            
            <div class="menu-item admin-only" data-command="traceroute" onclick="executeMenuCommand('traceroute')" style="display: none;">
                <span class="menu-cursor" id="cursor-5"> </span>
                <span class="menu-text">Traceroute</span>
                <span class="menu-desc">Trace network path</span>
            </div>
            
            <div class="menu-item admin-only" data-command="networking" onclick="executeMenuCommand('networking')" style="display: none;">
                <span class="menu-cursor" id="cursor-6"> </span>
                <span class="menu-text">Networking</span>
                <span class="menu-desc">Network tools menu</span>
            </div>
        </div>
        
        <div class="mutt-footer">
            <div class="mutt-help">Use ↑↓ to navigate, Enter to select, ESC to close</div>
        </div>
    </div>

    <script>
        const output = document.getElementById('output');
        const commandInput = document.getElementById('commandInput');
        const visualMenu = document.getElementById('visualMenu');
        const matrixScreensaver = document.getElementById('matrixScreensaver');
        
        // Login elements
        const loginScreen = document.getElementById('loginScreen');
        const terminalContainer = document.getElementById('terminalContainer');
        const loginInput = document.getElementById('loginInput');
        const passwordInput = document.getElementById('passwordInput');
        const passwordPrompt = document.getElementById('passwordPrompt');
        
        // Typing effect variables
        let isTyping = false;
        let typeQueue = [];
        let lastActivity = Date.now();
        
        // ZShell-like prompt variables
        let currentUser = 'user';
        let currentHost = 'pdp11';
        let currentDir = '/usr/user';
        let screensaverActive = false;
        
        // Matrix screensaver variables
        let matrixScene, matrixCamera, matrixRenderer;
        let matrixColumns = [];
        let matrixGeometry, matrixMaterial, matrixMesh;
        
        // Three.js CRT Effects Setup
        let scene, camera, renderer;
        let scanlineGeometry, scanlineMaterial, scanlineMesh;
        let interferenceGeometry, interferenceMaterial, interferenceMesh;
        let time = 0;
        
        function initCRTEffects() {
            const canvas = document.getElementById('crt-canvas');
            scene = new THREE.Scene();
            camera = new THREE.OrthographicCamera(-1, 1, 1, -1, 0.1, 10);
            
            renderer = new THREE.WebGLRenderer({ 
                canvas: canvas, 
                alpha: true,
                antialias: false 
            });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setClearColor(0x000000, 0);
            
            // Scanline effect
            const scanlineVertexShader = `
                varying vec2 vUv;
                void main() {
                    vUv = uv;
                    gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);
                }
            `;
            
            const scanlineFragmentShader = `
                uniform float time;
                uniform vec2 resolution;
                varying vec2 vUv;
                
                void main() {
                    vec2 uv = vUv;
                    
                    // Moving scanlines - thinner and less frequent
                    float scanline1 = sin((uv.y + time * 0.2) * 800.0) * 0.03;
                    float scanline2 = sin((uv.y - time * 0.15) * 600.0) * 0.02;
                    
                    // Horizontal sweep line - subtler
                    float sweepPos = mod(time * 0.1, 1.0);
                    float sweep = smoothstep(0.01, 0.0, abs(uv.y - sweepPos)) * 0.2;
                    sweep *= sin(time * 30.0) * 0.5 + 0.5; // Flickering
                    
                    // Secondary sweep - less frequent
                    float sweepPos2 = mod(time * 0.05 + 0.5, 1.0);
                    float sweep2 = smoothstep(0.005, 0.0, abs(uv.y - sweepPos2)) * 0.1;
                    sweep2 *= sin(time * 20.0 + 3.14) * 0.5 + 0.5;
                    
                    // Interference bars - less frequent and thinner
                    float interference = 0.0;
                    if (mod(time * 1.5, 10.0) < 0.5) {
                        float barPos = mod(time * 4.0, 1.0);
                        interference = smoothstep(0.01, 0.0, abs(uv.y - barPos)) * 0.2;
                        interference *= sin(time * 80.0) * 0.5 + 0.5;
                    }
                    
                    // Vertical sync issues - less frequent
                    float verticalGlitch = 0.0;
                    if (mod(time * 0.2, 15.0) < 0.2) {
                        verticalGlitch = step(0.01, sin(uv.x * 300.0 + time * 8.0)) * 0.05;
                    }
                    
                    // Phosphor decay simulation - subtler
                    float phosphor = sin(uv.y * 400.0) * 0.01;
                    
                    // Random noise - very subtle
                    float noise = fract(sin(dot(uv, vec2(12.9898, 78.233))) * 43758.5453) * 0.01;
                    
                    float intensity = scanline1 + scanline2 + sweep + sweep2 + interference + verticalGlitch + phosphor + noise;
                    
                    gl_FragColor = vec4(0.2, 1.0, 0.2, intensity);
                }
            `;
            
            scanlineGeometry = new THREE.PlaneGeometry(2, 2);
            scanlineMaterial = new THREE.ShaderMaterial({
                vertexShader: scanlineVertexShader,
                fragmentShader: scanlineFragmentShader,
                uniforms: {
                    time: { value: 0 },
                    resolution: { value: new THREE.Vector2(window.innerWidth, window.innerHeight) }
                },
                transparent: true,
                blending: THREE.AdditiveBlending
            });
            
            scanlineMesh = new THREE.Mesh(scanlineGeometry, scanlineMaterial);
            scene.add(scanlineMesh);
            
            camera.position.z = 1;
        }
        
        // Matrix Screensaver Setup - High Quality
        function initMatrixScreensaver() {
            const canvas = document.getElementById('matrix-canvas');
            const ctx = canvas.getContext('2d');
            
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            
            // Matrix characters (Japanese katakana, numbers, symbols)
            const matrixChars = 'ｱｲｳｴｵｶｷｸｹｺｻｼｽｾｿﾀﾁﾂﾃﾄﾅﾆﾇﾈﾉﾊﾋﾌﾍﾎﾏﾐﾑﾒﾓﾔﾕﾖﾗﾘﾙﾚﾛﾜﾝ0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz!@#$%^&*()_+-=[]{}|;:,.<>?';
            
            // Matrix columns
            const columns = Math.floor(canvas.width / 20);
            const drops = [];
            
            // Initialize drops
            for (let i = 0; i < columns; i++) {
                drops[i] = {
                    y: Math.random() * -canvas.height,
                    speed: 1 + Math.random() * 2,
                    length: 10 + Math.floor(Math.random() * 20),
                    chars: [],
                    brightness: Math.random()
                };
                
                // Generate random characters for this column
                for (let j = 0; j < drops[i].length; j++) {
                    drops[i].chars[j] = matrixChars[Math.floor(Math.random() * matrixChars.length)];
                }
            }
            
            // Matrix colors
            const colors = {
                bright: '#00ff00',
                medium: '#00cc00',
                dim: '#008800',
                veryDim: '#004400'
            };
            
            function drawMatrix() {
                if (!screensaverActive) return;
                
                // Semi-transparent black overlay for fade effect
                ctx.fillStyle = 'rgba(0, 0, 0, 0.05)';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                
                // Draw each column
                for (let i = 0; i < columns; i++) {
                    const x = i * 20;
                    const drop = drops[i];
                    
                    // Update drop position
                    drop.y += drop.speed;
                    
                    // Reset drop if it goes off screen
                    if (drop.y > canvas.height + drop.length * 20) {
                        drop.y = Math.random() * -100;
                        drop.brightness = Math.random();
                        // Regenerate characters
                        for (let j = 0; j < drop.length; j++) {
                            drop.chars[j] = matrixChars[Math.floor(Math.random() * matrixChars.length)];
                        }
                    }
                    
                    // Draw characters in this column
                    for (let j = 0; j < drop.length; j++) {
                        const charY = drop.y - j * 20;
                        
                        if (charY >= -20 && charY < canvas.height) {
                            // Calculate brightness based on position
                            let brightness = 1 - (j / drop.length);
                            brightness *= drop.brightness;
                            
                            // Add some flickering
                            brightness *= 0.8 + 0.4 * Math.random();
                            
                            // Choose color based on brightness
                            let color;
                            if (brightness > 0.8) {
                                color = colors.bright;
                            } else if (brightness > 0.5) {
                                color = colors.medium;
                            } else if (brightness > 0.2) {
                                color = colors.dim;
                            } else {
                                color = colors.veryDim;
                            }
                            
                            // Draw character
                            ctx.fillStyle = color;
                            ctx.font = '16px "Courier New", monospace';
                            ctx.fillText(drop.chars[j], x, charY);
                            
                            // Add glow effect for bright characters
                            if (brightness > 0.8) {
                                ctx.shadowColor = '#00ff00';
                                ctx.shadowBlur = 10;
                                ctx.fillText(drop.chars[j], x, charY);
                                ctx.shadowBlur = 0;
                            }
                        }
                    }
                }
                
                requestAnimationFrame(drawMatrix);
            }
            
            // Start animation
            drawMatrix();
        }
        
        function animateMatrix() {
            // Animation is now handled inside initMatrixScreensaver
            // This function is kept for compatibility
        }
        
        function showScreensaver() {
            screensaverActive = true;
            matrixScreensaver.style.display = 'block';
            initMatrixScreensaver();
        }
        
        function hideScreensaver() {
            screensaverActive = false;
            matrixScreensaver.style.display = 'none';
            lastActivity = Date.now();
        }
        
        function animateCRT() {
            requestAnimationFrame(animateCRT);
            
            time += 0.016; // ~60fps
            scanlineMaterial.uniforms.time.value = time;
            
            // Random screen flicker - less frequent and subtler
            if (Math.random() < 0.02) {
                scanlineMaterial.uniforms.time.value += Math.random() * 0.1;
            }
            
            // Additional random interference - less frequent
            if (Math.random() < 0.01) {
                scanlineMaterial.uniforms.time.value += Math.random() * 0.08;
            }
            
            renderer.render(scene, camera);
        }
        
        // Handle window resize
        window.addEventListener('resize', () => {
            const width = window.innerWidth;
            const height = window.innerHeight;
            
            renderer.setSize(width, height);
            scanlineMaterial.uniforms.resolution.value.set(width, height);
            
            // Resize matrix canvas
            const matrixCanvas = document.getElementById('matrix-canvas');
            if (matrixCanvas) {
                matrixCanvas.width = width;
                matrixCanvas.height = height;
            }
            
            // Resize tunnel canvas
            const tunnelCanvas = document.getElementById('tunnelCanvas');
            if (tunnelCanvas) {
                tunnelCanvas.width = width;
                tunnelCanvas.height = height;
            }
        });
        
        // Commands
        const commands = {
            help: () => {
                let helpText = `help     menu     visual   about
projects contact  clear    date
who      uname    ls       pwd
logout`;
                
                if (window.isAdmin) {
                    helpText += `

<span class="highlight">ADMIN COMMANDS:</span>
networking ping     traceroute  nslookup
netstat    whois    system

<span class="highlight">SYSTEM COMMANDS:</span>
motd    matrix`;
                }
                
                helpText += `

<span class="highlight">SYSTEM COMMANDS:</span>
motd    matrix

<span class="highlight">AI ASSISTANT:</span>
Unknown commands are automatically processed by AI
Legal questions are detected and routed to legal database`;
                
                return helpText;
            },
            
            menu: () => {
                return `about    projects contact  visual`;
            },
            
            about: () => {
                return `UNIX/32V - Bell Telephone Laboratories
DEC PDP-11/70 (16-bit minicomputer)
Teletype Model ASR-37 Terminal
128K words core memory
RK05 disk cartridge (2.5MB)
300 baud serial connection`;
            },
            
            projects: () => {
                return `CRT Terminal Emulator
Teletype Command Parser
Phosphor Display Renderer
Retro System Interface`;
            },
            
            contact: () => {
                return `sysadmin@pdp11.bell-labs.arpa
...!ucbvax!terminal!user
user@bsd-terminal.arpa
+1-415-642-4948`;
            },
            
            visual: () => {
                showVisualMenu();
                return `<span class="success">Opening MUTT-style menu interface...</span>`;
            },
            
            clear: () => {
                output.innerHTML = '';
                return '';
            },
            
            date: () => {
                const now = new Date();
                const vintage = `Mon Aug  4 14:${String(now.getMinutes()).padStart(2, '0')}:${String(now.getSeconds()).padStart(2, '0')} PDT 1975`;
                return `<span class="success">${vintage}</span>`;
            },
            
            who: () => {
                return `<span class="success">user    tty03   Aug  4 14:30</span>`;
            },
            
            uname: () => {
                return `<span class="success">UNIX/32V PDP-11/70</span>`;
            },
            
            ls: (args) => {
                const dirs = {
                    '/': 'bin/     etc/     usr/     var/',
                    '/usr': 'bin/     lib/     user/    include/',
                    '/usr/user': 'bin/     doc/     src/\nREADME   .profile startup',
                    '/usr/bin': 'ls       cat      echo     pwd\ncd       help     clear    date',
                    '/etc': 'passwd   hosts    fstab    motd',
                    '/var': 'log/     tmp/     spool/   cache/'
                };
                
                const targetDir = args && args.length > 0 ? args[0] : currentDir;
                const contents = dirs[targetDir] || dirs[currentDir] || 'bin/     doc/     src/\nREADME   .profile startup';
                
                return contents;
            },
            
            pwd: () => {
                return `<span class="success">${currentDir}</span>`;
            },
            
            cd: (args) => {
                if (!args || args.length === 0) {
                    return `<span class="error">cd: usage: cd <directory></span>`;
                }
                
                const newDir = args[0];
                if (newDir === '..') {
                    // Go up one directory
                    const parts = currentDir.split('/');
                    if (parts.length > 2) {
                        parts.pop();
                        currentDir = parts.join('/');
                    }
                } else if (newDir === '~' || newDir === '/') {
                    // Go to home or root
                    currentDir = newDir === '~' ? '/usr/user' : '/';
                } else if (newDir.startsWith('/')) {
                    // Absolute path
                    currentDir = newDir;
                } else {
                    // Relative path
                    currentDir = currentDir.endsWith('/') ? currentDir + newDir : currentDir + '/' + newDir;
                }
                
                updatePrompt();
                return `<span class="success">Changed directory to: ${currentDir}</span>`;
            },
            
            logout: () => {
                // CRT Power Off Effect
                const terminalContainer = document.getElementById('terminalContainer');
                terminalContainer.classList.add('crt-power-off');
                
                // After power off animation, show logout message and redirect
                setTimeout(() => {
                    output.innerHTML = '';
                    const logoutDiv = document.createElement('div');
                    logoutDiv.innerHTML = `<span class="error">Connection to PDP-11/70 closed by remote host.</span>
<span class="info">Use browser refresh to reconnect to terminal.</span>`;
                    output.appendChild(logoutDiv);
                    
                    // Redirect to login after showing message
                    setTimeout(() => {
                        location.reload();
                    }, 3000);
                }, 1500);
                
                return '';
            },
            
            // Admin-only networking commands
            networking: () => {
                if (!window.isAdmin) {
                    return `<span class="error">networking: Permission denied. Admin access required.</span>`;
                }
                return `ping       traceroute  nslookup
netstat    whois      system
Use 'ping <host>' or 'traceroute <host>' to test connectivity.

<span class="highlight">OTHER COMMANDS:</span>
motd - Generate Bender-style message of the day
show motd db - Display MOTD database history`;
            },
            
            ping: (args) => {
                if (!window.isAdmin) {
                    return `<span class="error">ping: Permission denied. Admin access required.</span>`;
                }
                if (!args || args.length === 0) {
                    return `<span class="error">ping: usage: ping <hostname></span>`;
                }
                return performPing(args[0]);
            },
            
            traceroute: (args) => {
                if (!window.isAdmin) {
                    return `<span class="error">traceroute: Permission denied. Admin access required.</span>`;
                }
                if (!args || args.length === 0) {
                    return `<span class="error">traceroute: usage: traceroute <hostname></span>`;
                }
                return performTraceroute(args[0]);
            },
            
            nslookup: (args) => {
                if (!window.isAdmin) {
                    return `<span class="error">nslookup: Permission denied. Admin access required.</span>`;
                }
                if (!args || args.length === 0) {
                    return `<span class="error">nslookup: usage: nslookup <hostname></span>`;
                }
                return performNslookup(args[0]);
            },
            
            netstat: (args) => {
                if (!window.isAdmin) {
                    return `<span class="error">netstat: Permission denied. Admin access required.</span>`;
                }
                return performNetstat(args);
            },
            
            whois: (args) => {
                if (!window.isAdmin) {
                    return `<span class="error">whois: Permission denied. Admin access required.</span>`;
                }
                if (!args || args.length === 0) {
                    return `<span class="error">whois: usage: whois <domain></span>`;
                }
                return performWhois(args[0]);
            },
            
            motd: () => {
                return performMotd();
            },
            
            'show motd db': () => {
                return performShowMotdDb();
            },
            
            system: () => {
                if (!window.isAdmin) {
                    return `<span class="error">system: Permission denied. Admin access required.</span>`;
                }
                return performSystemInfo();
            },
            
            matrix: () => {
                showScreensaver();
                return `<span class="success">Activating Matrix screensaver...</span>`;
            }
        };
        
        // Real networking functions using backend API
        async function performPing(hostname) {
            try {
                const response = await fetch('/api/ping', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ hostname })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    return data.output;
                } else {
                    return `ping: ${data.error}`;
                }
            } catch (error) {
                return `ping: ${error.message}`;
            }
        }
        
        async function performTraceroute(hostname) {
            try {
                const response = await fetch('/api/traceroute', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ hostname })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    return data.output;
                } else {
                    return `traceroute: ${data.error}`;
                }
            } catch (error) {
                return `traceroute: ${error.message}`;
            }
        }
        
        async function performNslookup(hostname) {
            try {
                const response = await fetch('/api/nslookup', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ hostname })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    return data.output;
                } else {
                    return `nslookup: ${data.error}`;
                }
            } catch (error) {
                return `nslookup: ${error.message}`;
            }
        }
        
        async function performNetstat(args = []) {
            try {
                const response = await fetch('/api/netstat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ args })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    return data.output;
                } else {
                    return `netstat: ${data.error}`;
                }
            } catch (error) {
                return `netstat: ${error.message}`;
            }
        }
        
        async function performWhois(domain) {
            try {
                const response = await fetch('/api/whois', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ domain })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    return data.output;
                } else {
                    return `whois: ${data.error}`;
                }
            } catch (error) {
                return `whois: ${error.message}`;
            }
        }
        
        async function performSystemInfo() {
            try {
                const response = await fetch('/api/system');
                const data = await response.json();
                
                if (response.ok) {
                    return `Platform: ${data.platform}
Architecture: ${data.arch}
Node Version: ${data.nodeVersion}
Uptime: ${Math.floor(data.uptime)} seconds`;
                } else {
                    return `system: ${data.error}`;
                }
            } catch (error) {
                return `system: ${error.message}`;
            }
        }
        
        async function performMotd() {
            try {
                const response = await fetch('/api/motd', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({})
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    return data.output;
                } else {
                    return `motd: ${data.error}`;
                }
            } catch (error) {
                return `motd: ${error.message}`;
            }
        }

        async function performShowMotdDb() {
            try {
                const response = await fetch('/api/motd/history', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    let output = '=== MOTD Database History ===\n\n';
                    
                    if (data.history && data.history.length > 0) {
                        data.history.forEach((entry, index) => {
                            const date = new Date(entry.created_at).toLocaleString();
                            output += `${index + 1}. [${date}] [${entry.language || 'en'}] ${entry.message}\n`;
                        });
                    } else {
                        output += 'No MOTD entries found in database.\n';
                    }
                    
                    return output;
                } else {
                    return `show motd db: ${data.error}`;
                }
            } catch (error) {
                return `show motd db: ${error.message}`;
            }
        }

        async function processUnknownCommand(command) {
            try {
                const response = await fetch('/api/process-command', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ 
                        command: command,
                        isAdmin: window.isAdmin || false
                    })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    return data.output;
                } else {
                    return `${command}: ${data.error}`;
                }
            } catch (error) {
                return `${command}: ${error.message}`;
            }
        }
        
        commandInput.addEventListener('keydown', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                e.stopPropagation();
                const command = this.value.trim().toLowerCase();
                executeCommand(command);
                this.value = '';
                this.focus();
            }
        });
        
        // Ensure input stays focused
        commandInput.addEventListener('blur', function() {
            setTimeout(() => this.focus(), 10);
        });
        
        // Additional Enter key handling
        commandInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                e.stopPropagation();
                const command = this.value.trim().toLowerCase();
                executeCommand(command);
                this.value = '';
                this.focus();
            }
        });
        
        function executeCommand(command) {
            lastActivity = Date.now(); // Reset activity timer
            
            // Add command to output with authentic 70s prompt
            const commandLine = document.createElement('div');
            commandLine.className = 'output-line';
            commandLine.innerHTML = `<span class="prompt">%</span> ${command}`;
            output.appendChild(commandLine);
            
            // Parse command and arguments
            const parts = command.trim().split(/\s+/);
            const commandName = parts[0].toLowerCase();
            const args = parts.slice(1);
            
            // Execute command
            let result;
            
            // First check for exact command match (including commands with spaces)
            if (commands[command]) {
                if (typeof commands[command] === 'function') {
                    result = commands[command](args);
                } else {
                    result = commands[command]();
                }
            } else if (commands[commandName]) {
                // Fallback to first word matching
                if (typeof commands[commandName] === 'function') {
                    result = commands[commandName](args);
                } else {
                    result = commands[commandName]();
                }
            } else if (commandName === '') {
                result = '';
            } else {
                // Process unknown command through AI
                result = processUnknownCommand(command);
            }
            
            if (result) {
                const resultDiv = document.createElement('div');
                resultDiv.className = 'output-line';
                output.appendChild(resultDiv);
                
                // Handle async results
                if (result instanceof Promise) {
                    result.then(asyncResult => {
                        queueType(resultDiv, asyncResult, 30);
                    }).catch(error => {
                        queueType(resultDiv, `<span class="error">Error: ${error.message}</span>`, 30);
                    });
                } else {
                    // Type the result with delay
                    queueType(resultDiv, result, 30);
                }
                
                // Ensure scroll after adding new content
                setTimeout(() => {
                    autoScrollIfNearBottom();
                }, 50);
            }
            
            // Auto-scroll to bottom after command execution
            setTimeout(() => {
                autoScrollIfNearBottom();
            }, 100);
            
            // Close visual menu if open
            if (command !== 'visual') {
                visualMenu.style.display = 'none';
            }
        }
        
        // MUTT-style menu variables
        let currentMenuIndex = 0;
        let menuItems = [];
        
        function closeVisualMenu() {
            visualMenu.style.display = 'none';
            commandInput.focus();
            currentMenuIndex = 0;
            updateMenuCursor();
        }
        
        function executeMenuCommand(command) {
            closeVisualMenu();
            
            // Special handling for commands that need arguments
            if (command === 'ping' || command === 'traceroute') {
                const hostname = prompt(`Enter hostname for ${command}:`);
                if (hostname) {
                    executeCommand(`${command} ${hostname}`);
                }
            } else {
                executeCommand(command);
            }
        }
        
        function updateMenuCursor() {
            // Clear all cursors
            document.querySelectorAll('.menu-cursor').forEach(cursor => {
                cursor.textContent = ' ';
            });
            
            // Set current cursor
            if (menuItems[currentMenuIndex]) {
                const cursor = menuItems[currentMenuIndex].querySelector('.menu-cursor');
                if (cursor) {
                    cursor.textContent = '>';
                }
            }
        }
        
        function showVisualMenu() {
            visualMenu.style.display = 'block';
            
            // Get all visible menu items
            menuItems = Array.from(document.querySelectorAll('.menu-item:not([style*="display: none"])'));
            currentMenuIndex = 0;
            updateMenuCursor();
            
            // Show admin options if admin
            if (window.isAdmin) {
                document.querySelectorAll('.admin-only').forEach(item => {
                    item.style.display = 'flex';
                });
                menuItems = Array.from(document.querySelectorAll('.menu-item:not([style*="display: none"])'));
            }
            
            // Focus on menu for keyboard navigation
            visualMenu.focus();
        }
        
        // Keyboard navigation for MUTT menu
        document.addEventListener('keydown', function(e) {
            if (visualMenu.style.display === 'block') {
                switch(e.key) {
                    case 'ArrowUp':
                        e.preventDefault();
                        currentMenuIndex = (currentMenuIndex - 1 + menuItems.length) % menuItems.length;
                        updateMenuCursor();
                        break;
                    case 'ArrowDown':
                        e.preventDefault();
                        currentMenuIndex = (currentMenuIndex + 1) % menuItems.length;
                        updateMenuCursor();
                        break;
                    case 'Enter':
                        e.preventDefault();
                        if (menuItems[currentMenuIndex]) {
                            const command = menuItems[currentMenuIndex].getAttribute('data-command');
                            if (command) {
                                executeMenuCommand(command);
                            }
                        }
                        break;
                    case 'Escape':
                        e.preventDefault();
                        closeVisualMenu();
                        break;
                }
            }
        });
        
        // Smooth scrolling function
        function smoothScrollToBottom() {
            const output = document.getElementById('output');
            if (output) {
                const scrollHeight = output.scrollHeight;
                const clientHeight = output.clientHeight;
                const maxScrollTop = scrollHeight - clientHeight;
                
                // Only scroll if content is actually overflowing
                if (maxScrollTop > 0) {
                    // Smooth scroll to bottom
                    output.scrollTo({
                        top: maxScrollTop,
                        behavior: 'smooth'
                    });
                }
            }
        }
        
        // Auto-scroll function that checks if we're near the bottom
        function autoScrollIfNearBottom() {
            const output = document.getElementById('output');
            if (output) {
                const scrollTop = output.scrollTop;
                const scrollHeight = output.scrollHeight;
                const clientHeight = output.clientHeight;
                const threshold = 50; // pixels from bottom
                
                // If we're within 50 pixels of the bottom, auto-scroll
                if (scrollHeight - scrollTop - clientHeight < threshold) {
                    smoothScrollToBottom();
                }
            }
        }
        
        // Monitor DOM changes for auto-scroll
        function setupAutoScrollMonitor() {
            const output = document.getElementById('output');
            if (output) {
                // Use MutationObserver to watch for new content
                const observer = new MutationObserver((mutations) => {
                    mutations.forEach((mutation) => {
                        if (mutation.type === 'childList' && mutation.addedNodes.length > 0) {
                            // New content was added, check if we should auto-scroll
                            setTimeout(() => {
                                autoScrollIfNearBottom();
                            }, 10);
                        }
                    });
                });
                
                // Start observing
                observer.observe(output, {
                    childList: true,
                    subtree: true
                });
            }
        }
        
        // Typing effect function with auto-scroll
        function queueType(element, text, speed = 30) {
            if (isTyping) {
                typeQueue.push({ element, text, speed });
                return;
            }
            
            isTyping = true;
            let index = 0;
            
            function typeChar() {
                if (index < text.length) {
                    element.innerHTML += text[index];
                    index++;
                    
                    // Auto-scroll during typing if near bottom
                    autoScrollIfNearBottom();
                    
                    setTimeout(typeChar, speed);
                } else {
                    isTyping = false;
                    
                    // Final scroll after typing is complete
                    setTimeout(smoothScrollToBottom, 50);
                    
                    if (typeQueue.length > 0) {
                        const next = typeQueue.shift();
                        queueType(next.element, next.text, next.speed);
                    }
                }
            }
            
            typeChar();
        }
        
        // Login functionality
        function handleLogin() {
            const username = loginInput.value.trim();
            if (username) {
                // Cancel Matrix effect timeout
                if (matrixTimeout) {
                    clearTimeout(matrixTimeout);
                    matrixTimeout = null;
                }
                
                // Show password prompt
                const passwordPromptLine = document.getElementById('passwordPromptLine');
                passwordPromptLine.style.display = 'flex';
                passwordInput.focus();
                
                // Check if it's admin login
                if (username.toLowerCase() === 'admin') {
                    // Admin login - will have additional privileges
                    setTimeout(() => {
                        // CRT Power Off Effect for login screen
                        loginScreen.classList.add('crt-power-off');
                        
                        setTimeout(() => {
                            loginScreen.style.display = 'none';
                            terminalContainer.style.display = 'flex';
                            initTerminal(true); // true for admin
                        }, 1500);
                    }, 1000);
                } else {
                    // Regular user login
                    setTimeout(() => {
                        // CRT Power Off Effect for login screen
                        loginScreen.classList.add('crt-power-off');
                        
                        setTimeout(() => {
                            loginScreen.style.display = 'none';
                            terminalContainer.style.display = 'flex';
                            initTerminal(false); // false for regular user
                        }, 1500);
                    }, 1000);
                }
            }
        }
        
        // Login event listeners
        loginInput.addEventListener('keydown', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                handleLogin();
            }
        });
        
        passwordInput.addEventListener('keydown', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                
                // Cancel Matrix effect timeout
                if (matrixTimeout) {
                    clearTimeout(matrixTimeout);
                    matrixTimeout = null;
                }
                
                // CRT Power Off Effect for login screen
                loginScreen.classList.add('crt-power-off');
                
                setTimeout(() => {
                    loginScreen.style.display = 'none';
                    terminalContainer.style.display = 'flex';
                    initTerminal();
                }, 1500);
            }
        });
        
        // Initialize login screen with boot messages
        function initLoginScreen() {
            const loginScreen = document.getElementById('loginScreen');
            
            // CRT Power On Effect for login screen
            loginScreen.classList.add('crt-power-on');
            
            // Remove power-on class after animation
            setTimeout(() => {
                loginScreen.classList.remove('crt-power-on');
            }, 2000);
            
            const loginOutput = document.getElementById('loginOutput');
            const bootMessages = [
                'UNIX/32V System Boot',
                'Bell Telephone Laboratories, Inc.',
                'Berkeley Software Distribution',
                'Memory: 128K words',
                'Disk: RK05 Cartridge',
                'TTY: /dev/tty03 at 300 baud',
                'Login: Mon Aug  4 14:30:21 PDT 1975',
                '',
                'UNIX/32V System Ready',
                ''
            ];
            
            loginOutput.innerHTML = '';
            bootMessages.forEach((msg, index) => {
                setTimeout(() => {
                    const div = document.createElement('div');
                    div.className = 'output-line' + (index === 8 ? ' success' : '');
                    loginOutput.appendChild(div);
                    queueType(div, msg, 40);
                    
                    // Auto-scroll login output
                    setTimeout(() => {
                        if (loginOutput.scrollHeight > loginOutput.clientHeight) {
                            loginOutput.scrollTo({
                                top: loginOutput.scrollHeight,
                                behavior: 'smooth'
                            });
                        }
                    }, 100);
                }, index * 600);
            });
        }
        
        // Matrix Follow the White Rabbit Effect Functions
        let matrixTimeout;
        let tunnelAnimation;
        
        function startMatrixEffect() {
            const matrixOverlay = document.getElementById('matrixOverlay');
            const matrixText = document.getElementById('matrixText');
            const loginOutput = document.getElementById('loginOutput');
            
            // Clear login output
            loginOutput.innerHTML = '';
            
            // Show matrix overlay
            matrixOverlay.style.display = 'block';
            
            // Type "Follow the white rabbit..."
            const text = "Follow the white rabbit...";
            let index = 0;
            
            function typeMatrixText() {
                if (index < text.length) {
                    matrixText.textContent += text[index];
                    index++;
                    setTimeout(typeMatrixText, 100);
                } else {
                    // Wait 2 seconds then hide matrix overlay
                    setTimeout(() => {
                        matrixOverlay.style.display = 'none';
                    }, 2000);
                }
            }
            
            typeMatrixText();
        }
        

        
                // Startup animation sequence
        let startupAnimationStarted = false;
        function startStartupAnimation() {
            if (startupAnimationStarted) {
                return; // Prevent multiple starts
            }
            startupAnimationStarted = true;
            
            const startupAnimation = document.getElementById('startupAnimation');
            const startupText = document.getElementById('startupText');
            const tunnelAnimation = document.getElementById('tunnelAnimation');
            const loginScreen = document.getElementById('loginScreen');
            
            // Show startup animation
            startupAnimation.style.display = 'flex';
            
            // Type "Follow The White Rabbit" character by character
            const message = "Follow The White Rabbit";
            let currentIndex = 0;
            
            // Show the text container first
            startupText.classList.add('visible');
            
            function typeCharacter() {
                if (currentIndex < message.length) {
                    startupText.textContent += message[currentIndex];
                    currentIndex++;
                    setTimeout(typeCharacter, 120); // 120ms delay between characters for better effect
                } else {
                    // Add dots after the message
                    setTimeout(() => {
                        startupText.textContent += ".";
                        setTimeout(() => {
                            startupText.textContent += ".";
                            setTimeout(() => {
                                startupText.textContent += ".";
                                // Wait 3 seconds after dots
                                setTimeout(() => {
                                    // Hide startup text and show tunnel
                                    startupAnimation.style.display = 'none';
                                    tunnelAnimation.style.display = 'block';
                                    
                                    // Run tunnel animation for 5 seconds
                                    setTimeout(() => {
                                        // Hide tunnel and show terminal directly
                                        tunnelAnimation.style.display = 'none';
                                        
                                        // Show terminal container directly
                                        const terminalContainer = document.getElementById('terminalContainer');
                                        terminalContainer.style.display = 'flex';
                                        
                                        // Initialize the terminal silently (without boot messages)
                                        initTerminalSilent(false);
                                        
                                        // Initialize the rest of the application
                                        initCRTEffects();
                                        animateCRT();
                                        
                                        // Start Matrix effect after 5 seconds if no activity
                                        matrixTimeout = setTimeout(() => {
                                            startMatrixEffect();
                                        }, 5000);
                                    }, 5000); // 5 seconds tunnel animation
                                }, 3000); // 3 seconds wait after dots
                            }, 500);
                        }, 500);
                    }, 500);
                }
            }
            
            // Start typing
            typeCharacter();
        }
        
        // Initialize everything
        document.addEventListener('DOMContentLoaded', function() {
            // Hide both login screen and terminal initially
            const loginScreen = document.getElementById('loginScreen');
            const terminalContainer = document.getElementById('terminalContainer');
            loginScreen.style.display = 'none';
            terminalContainer.style.display = 'none';
            
            // Start the startup animation
            startStartupAnimation();
        });
        
        // Function to update ZShell-like prompt
        function updatePrompt() {
            const promptSymbol = document.getElementById('promptSymbol');
            const symbol = window.isAdmin ? '#' : '$';
            promptSymbol.textContent = `${currentUser}@${currentHost}:${currentDir} ${symbol}`;
        }
        
        // Terminal initialization function (without boot messages for startup animation)
        function initTerminalSilent(isAdmin = false) {
            // Store admin status globally
            window.isAdmin = isAdmin;
            
            // Set user based on login
            currentUser = isAdmin ? 'admin' : 'user';
            
            // Update prompt
            updatePrompt();
            
            // CRT Power On Effect
            const terminalContainer = document.getElementById('terminalContainer');
            terminalContainer.style.display = 'block';
            terminalContainer.classList.add('crt-power-on');
            
            // Remove power-on class after animation
            setTimeout(() => {
                terminalContainer.classList.remove('crt-power-on');
            }, 2000);
            
            // Track user activity for screensaver
            function resetActivity() {
                lastActivity = Date.now();
                if (screensaverActive) {
                    hideScreensaver();
                }
            }
            
            // Activity listeners
            document.addEventListener('keydown', function(e) {
                // Don't reset activity for input field keydown events
                if (e.target !== commandInput) {
                    resetActivity();
                }
            });
            document.addEventListener('mousemove', resetActivity);
            document.addEventListener('click', resetActivity);
            
            // Check for screensaver every second
            setInterval(() => {
                if (Date.now() - lastActivity > 60000 && !screensaverActive) { // 60 seconds
                    showScreensaver();
                }
            }, 1000);
            
            // Clear output and show ready prompt
            output.innerHTML = '';
            const readyDiv = document.createElement('div');
            readyDiv.className = 'output-line success';
            output.appendChild(readyDiv);
            queueType(readyDiv, 'UNIX/32V System Ready', 40);
            
            // Display MOTD after a short delay
            setTimeout(async () => {
                try {
                    const response = await fetch('/api/motd', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({})
                    });
                    
                    const data = await response.json();
                    
                    if (response.ok) {
                        // Split the MOTD output by lines and display each line separately
                        const motdLines = data.output.split('\n');
                        motdLines.forEach((line, index) => {
                            if (line.trim()) {
                                const motdDiv = document.createElement('div');
                                motdDiv.className = 'output-line motd';
                                output.appendChild(motdDiv);
                                queueType(motdDiv, line.trim(), 30);
                            }
                        });
                    } else {
                        // Fallback MOTD if API fails
                        const motdDiv = document.createElement('div');
                        motdDiv.className = 'output-line motd';
                        output.appendChild(motdDiv);
                        queueType(motdDiv, `"Bite my shiny metal ASCII! Welcome to UNIX/32V, meatbag!"`, 30);
                    }
                } catch (error) {
                    // Fallback MOTD if network fails
                    const motdDiv = document.createElement('div');
                    motdDiv.className = 'output-line motd';
                    output.appendChild(motdDiv);
                    queueType(motdDiv, `"Bite my shiny metal ASCII! Welcome to UNIX/32V, meatbag!"`, 30);
                    console.log('MOTD not available:', error.message);
                }
            }, 800); // Shorter delay for startup animation
            
            // Focus on command input and activate prompt
            setTimeout(() => {
                commandInput.focus();
                
                // Update prompt symbol for admin
                const promptSymbol = document.getElementById('promptSymbol');
                if (isAdmin) {
                    promptSymbol.textContent = '#';
                }
                
                document.addEventListener('click', () => {
                    commandInput.focus();
                });
                
                // Setup auto-scroll monitoring
                setupAutoScrollMonitor();
            }, 1200); // Wait for MOTD to finish
            
            // Additional screen effects - more frequent and varied
        }
        
        // Original terminal initialization function (with full boot messages)
        function initTerminal(isAdmin = false) {
            // Store admin status globally
            window.isAdmin = isAdmin;
            
            // Set user based on login
            currentUser = isAdmin ? 'admin' : 'user';
            
            // Update prompt
            updatePrompt();
            
            // CRT Power On Effect
            const terminalContainer = document.getElementById('terminalContainer');
            terminalContainer.style.display = 'block';
            terminalContainer.classList.add('crt-power-on');
            
            // Remove power-on class after animation
            setTimeout(() => {
                terminalContainer.classList.remove('crt-power-on');
            }, 2000);
            
            // Track user activity for screensaver
            function resetActivity() {
                lastActivity = Date.now();
                if (screensaverActive) {
                    hideScreensaver();
                }
            }
            
            // Activity listeners
            document.addEventListener('keydown', function(e) {
                // Don't reset activity for input field keydown events
                if (e.target !== commandInput) {
                    resetActivity();
                }
            });
            document.addEventListener('mousemove', resetActivity);
            document.addEventListener('click', resetActivity);
            
            // Check for screensaver every second
            setInterval(() => {
                if (Date.now() - lastActivity > 60000 && !screensaverActive) { // 60 seconds
                    showScreensaver();
                }
            }, 1000);
            
            // Initial boot sequence with typing effect
            const bootMessages = [
                isAdmin ? 'UNIX/32V System Ready (ADMIN MODE)' : 'UNIX/32V System Ready',
                ''
            ];
            
            output.innerHTML = '';
            bootMessages.forEach((msg, index) => {
                setTimeout(() => {
                    const div = document.createElement('div');
                    div.className = 'output-line' + (index === 0 ? ' success' : '');
                    output.appendChild(div);
                    queueType(div, msg, 40);
                }, index * 800);
            });
            
            // Display MOTD after boot sequence
            setTimeout(async () => {
                try {
                    const response = await fetch('/api/motd', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({})
                    });
                    
                    const data = await response.json();
                    
                    if (response.ok) {
                        const motdDiv = document.createElement('div');
                        motdDiv.className = 'output-line motd';
                        output.appendChild(motdDiv);
                        queueType(motdDiv, `MOTD: ${data.output}`, 30);
                    } else {
                        // Fallback MOTD if API fails
                        const motdDiv = document.createElement('div');
                        motdDiv.className = 'output-line motd';
                        output.appendChild(motdDiv);
                        queueType(motdDiv, `MOTD: "Bite my shiny metal ASCII! Welcome to UNIX/32V, meatbag!"`, 30);
                    }
                } catch (error) {
                    // Fallback MOTD if network fails
                    const motdDiv = document.createElement('div');
                    motdDiv.className = 'output-line motd';
                    output.appendChild(motdDiv);
                    queueType(motdDiv, `MOTD: "Bite my shiny metal ASCII! Welcome to UNIX/32V, meatbag!"`, 30);
                    console.log('MOTD not available:', error.message);
                }
            }, 1600); // Wait 1.6 seconds after boot messages
            
            // Additional screen effects - more frequent and varied
            setInterval(() => {
                if (Math.random() < 0.03) {
                    // Screen flicker
                    document.body.style.filter = 'brightness(1.3) contrast(0.9)';
                    setTimeout(() => {
                        document.body.style.filter = 'brightness(1) contrast(1)';
                    }, 80);
                }
            }, 500);
            
            // Additional interference effects
            setInterval(() => {
                if (Math.random() < 0.02) {
                    // Random brightness variation
                    document.body.style.filter = 'brightness(0.9) contrast(1.1)';
                    setTimeout(() => {
                        document.body.style.filter = 'brightness(1) contrast(1)';
                    }, 50);
                }
            }, 300);
            
            commandInput.focus();
            
            // Update prompt symbol for admin
            const promptSymbol = document.getElementById('promptSymbol');
            if (isAdmin) {
                promptSymbol.textContent = '#';
            }
            
            document.addEventListener('click', () => {
                commandInput.focus();
            });
            
            // Setup auto-scroll monitoring
            setupAutoScrollMonitor();
        }
        
        // Prevent context menu
        document.addEventListener('contextmenu', e => e.preventDefault());
    </script>
</body>
</html>